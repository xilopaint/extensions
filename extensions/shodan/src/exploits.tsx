import { useState } from "react";
import {
  List,
  ActionPanel,
  Action,
  Icon,
  getPreferenceValues,
  showToast,
  Toast,
  Color,
} from "@raycast/api";
import { useFetch } from "@raycast/utils";
import { ShodanExploitResponse } from "./api/types";
import { formatTimestamp, truncateString } from "./utils/formatters";
import { copyAsJSON } from "./utils/export";
import {
  usePlanCapabilities,
  getRequiredPlanForFeature,
} from "./hooks/usePlanCapabilities";
import { PremiumFeatureNotice } from "./components/PremiumFeatureNotice";

export default function ExploitsCommand() {
  const [searchQuery, setSearchQuery] = useState("");
  const [submittedQuery, setSubmittedQuery] = useState("");
  const [searchError, setSearchError] = useState<string | null>(null);
  const { apiKey } = getPreferenceValues<Preferences>();
  const {
    canAccessExploits,
    plan,
    isLoading: planLoading,
  } = usePlanCapabilities();

  const { data, isLoading } = useFetch<ShodanExploitResponse>(
    `https://exploits.shodan.io/api/search?query=${encodeURIComponent(submittedQuery)}&key=${apiKey}`,
    {
      execute: submittedQuery.length > 0,
      keepPreviousData: false,
      onData: () => {
        setSearchError(null);
      },
      onError: (err) => {
        let message = err.message;
        if (message.includes("401") || message.includes("403")) {
          message =
            "API key doesn't have access to the Exploits API. This requires a paid Shodan membership.";
        } else if (message.includes("429")) {
          message = "Rate limit exceeded. Please wait and try again.";
        }
        setSearchError(message);
        showToast({
          style: Toast.Style.Failure,
          title: "Exploit Search Failed",
          message,
        });
      },
    },
  );

  const handleSearch = (query: string) => {
    const trimmed = query.trim();
    if (trimmed.length > 0) {
      setSubmittedQuery(trimmed);
    }
  };

  const getSourceIcon = (source: string): Icon => {
    const sourceIcons: Record<string, Icon> = {
      "exploit-db": Icon.Bug,
      metasploit: Icon.Terminal,
      cve: Icon.Warning,
      packetstorm: Icon.Bolt,
      github: Icon.Code,
    };
    return sourceIcons[source.toLowerCase()] || Icon.Document;
  };

  const getTypeColor = (type: string): Color => {
    const typeColors: Record<string, Color> = {
      remote: Color.Red,
      local: Color.Orange,
      webapps: Color.Blue,
      dos: Color.Purple,
      shellcode: Color.Yellow,
    };
    return typeColors[type.toLowerCase()] || Color.SecondaryText;
  };

  if (!planLoading && !canAccessExploits) {
    return (
      <List navigationTitle="Search Exploits">
        <PremiumFeatureNotice
          feature="Exploit Search"
          requiredPlan={getRequiredPlanForFeature("exploits")}
          currentPlan={plan}
          description={`The Exploits API requires a Shodan Membership.\n\nYour current plan: ${plan.toUpperCase()}\n\nUpgrade to search for CVEs, exploit code, and vulnerability information.`}
        />
      </List>
    );
  }

  return (
    <List
      isLoading={isLoading || planLoading}
      searchBarPlaceholder="Search exploits (e.g., apache, CVE-2021-44228)..."
      searchText={searchQuery}
      onSearchTextChange={setSearchQuery}
      throttle
      actions={
        <ActionPanel>
          <Action
            title="Search"
            icon={Icon.MagnifyingGlass}
            onAction={() => handleSearch(searchQuery)}
          />
        </ActionPanel>
      }
    >
      {!submittedQuery && (
        <List.EmptyView
          title="Search Exploit Database"
          description="Enter a search query to find exploits. Examples: 'apache', 'CVE-2021-44228', 'wordpress'"
          icon={Icon.Bug}
          actions={
            <ActionPanel>
              <Action
                title="Search"
                icon={Icon.MagnifyingGlass}
                onAction={() => handleSearch(searchQuery)}
              />
            </ActionPanel>
          }
        />
      )}

      {submittedQuery && searchError && !isLoading && (
        <List.EmptyView
          title="Search Failed"
          description={searchError}
          icon={Icon.XMarkCircle}
        />
      )}

      {submittedQuery &&
        !searchError &&
        data?.matches?.length === 0 &&
        !isLoading && (
          <List.EmptyView
            title="No Exploits Found"
            description={`No exploits matching "${submittedQuery}".`}
            icon={Icon.XMarkCircle}
          />
        )}

      {data && data.matches && data.matches.length > 0 && (
        <List.Section
          title={`Exploits for "${submittedQuery}"`}
          subtitle={`${data.total.toLocaleString()} results`}
        >
          {data.matches.map((exploit, index) => (
            <List.Item
              key={`${exploit._id}-${index}`}
              title={truncateString(exploit.description, 60)}
              subtitle={exploit.author}
              icon={{
                source: getSourceIcon(exploit.source),
                tintColor: getTypeColor(exploit.type),
              }}
              accessories={[
                {
                  tag: {
                    value: exploit.type,
                    color: getTypeColor(exploit.type),
                  },
                },
                { tag: exploit.source },
                exploit.cve && exploit.cve.length > 0
                  ? { tag: { value: exploit.cve[0], color: Color.Red } }
                  : null,
                { text: formatTimestamp(exploit.date) },
              ].filter((a): a is NonNullable<typeof a> => a !== null)}
              actions={
                <ActionPanel>
                  <ActionPanel.Section title="View">
                    {exploit.source === "Exploit DB" && (
                      <Action.OpenInBrowser
                        title="View on Exploit-Db"
                        url={`https://www.exploit-db.com/exploits/${exploit._id.replace("exploitdb:", "")}`}
                      />
                    )}
                    {exploit.source === "Metasploit" && (
                      <Action.OpenInBrowser
                        title="View on Rapid7"
                        url={`https://www.rapid7.com/db/modules/${exploit._id.replace("msf:", "")}`}
                      />
                    )}
                    {exploit.cve && exploit.cve.length > 0 && (
                      <Action.OpenInBrowser
                        title={`View ${exploit.cve[0]} Details`}
                        url={`https://nvd.nist.gov/vuln/detail/${exploit.cve[0]}`}
                      />
                    )}
                  </ActionPanel.Section>

                  <ActionPanel.Section title="Copy">
                    <Action.CopyToClipboard
                      title="Copy Description"
                      content={exploit.description}
                      shortcut={{ modifiers: ["cmd"], key: "c" }}
                    />
                    {exploit.code && (
                      <Action.CopyToClipboard
                        title="Copy Exploit Code"
                        content={exploit.code}
                        shortcut={{ modifiers: ["cmd", "shift"], key: "c" }}
                      />
                    )}
                    {exploit.cve && exploit.cve.length > 0 && (
                      <Action.CopyToClipboard
                        title="Copy Cve"
                        content={exploit.cve.join(", ")}
                      />
                    )}
                    <Action
                      title="Copy as JSON"
                      icon={Icon.Clipboard}
                      onAction={() => copyAsJSON(exploit, "Exploit")}
                    />
                  </ActionPanel.Section>

                  <ActionPanel.Section title="Search">
                    {exploit.cve && exploit.cve.length > 0 && (
                      <Action
                        title={`Search Shodan for ${exploit.cve[0]}`}
                        icon={Icon.MagnifyingGlass}
                        onAction={() => {
                          setSearchQuery(exploit.cve![0]);
                          setSubmittedQuery(exploit.cve![0]);
                        }}
                      />
                    )}
                  </ActionPanel.Section>
                </ActionPanel>
              }
            />
          ))}
        </List.Section>
      )}
    </List>
  );
}
